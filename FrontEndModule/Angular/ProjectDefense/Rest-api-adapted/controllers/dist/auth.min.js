"use strict";function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)){var o=[],r=!0,n=!1,i=void 0;try{for(var s,a=e[Symbol.iterator]();!(r=(s=a.next()).done)&&(o.push(s.value),!t||o.length!==t);r=!0);}catch(e){n=!0,i=e}finally{try{r||null==a.return||a.return()}finally{if(n)throw i}}return o}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _objectWithoutProperties(e,t){if(null==e)return{};var o,r,n=_objectWithoutPropertiesLoose(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)o=i[r],0<=t.indexOf(o)||Object.prototype.propertyIsEnumerable.call(e,o)&&(n[o]=e[o])}return n}function _objectWithoutPropertiesLoose(e,t){if(null==e)return{};var o,r,n={},i=Object.keys(e);for(r=0;r<i.length;r++)o=i[r],0<=t.indexOf(o)||(n[o]=e[o]);return n}var _require=require("../models"),userModel=_require.userModel,tokenBlacklistModel=_require.tokenBlacklistModel,utils=require("../utils"),_require2=require("../app-config"),authCookieName=_require2.authCookieName,bsonToJson=function(e){return JSON.parse(JSON.stringify(e))},removePassword=function(e){e.password,e.__v;return _objectWithoutProperties(e,["password","__v"])};function register(e,o,r){var t=e.body,n=t.tel,i=t.email,s=t.username,a=t.password;t.repeatPassword;return userModel.create({tel:n,email:i,username:s,password:a}).then(function(e){e=bsonToJson(e),e=removePassword(e);var t=utils.jwt.createToken({id:e._id});"production"===process.env.NODE_ENV?o.cookie(authCookieName,t,{httpOnly:!0,sameSite:"none",secure:!0}):o.cookie(authCookieName,t,{httpOnly:!0}),o.status(200).send(e)}).catch(function(e){if("MongoError"===e.name&&11e3===e.code){var t=e.message.split("index: ")[1];return t=(t=t.split(" dup key")[0]).substring(0,t.lastIndexOf("_")),void o.status(409).send({message:"This ".concat(t," is already registered!")})}r(e)})}function login(e,n,t){var o=e.body,r=o.email,i=o.password;userModel.findOne({email:r}).then(function(e){return Promise.all([e,!!e&&e.matchPassword(i)])}).then(function(e){var t=_slicedToArray(e,2),o=t[0];if(t[1]){o=bsonToJson(o),o=removePassword(o);var r=utils.jwt.createToken({id:o._id});"production"===process.env.NODE_ENV?n.cookie(authCookieName,r,{httpOnly:!0,sameSite:"none",secure:!0}):n.cookie(authCookieName,r,{httpOnly:!0}),n.status(200).send(o)}else n.status(401).send({message:"Wrong email or password"})}).catch(t)}function logout(e,t){var o=e.cookies[authCookieName];tokenBlacklistModel.create({token:o}).then(function(){t.clearCookie(authCookieName).status(204).send({message:"Logged out!"})}).catch(function(e){return t.send(e)})}function getProfileInfo(e,t,o){var r=e.user._id;userModel.findOne({_id:r},{password:0,__v:0}).then(function(e){t.status(200).json(e)}).catch(o)}function editProfileInfo(e,t,o){var r=e.user._id,n=e.body,i=n.tel,s=n.username,a=n.email;userModel.findOneAndUpdate({_id:r},{tel:i,username:s,email:a},{runValidators:!0,new:!0}).then(function(e){t.status(200).json(e)}).catch(o)}module.exports={login:login,register:register,logout:logout,getProfileInfo:getProfileInfo,editProfileInfo:editProfileInfo};
//# sourceMappingURL=auth.min.js.map
